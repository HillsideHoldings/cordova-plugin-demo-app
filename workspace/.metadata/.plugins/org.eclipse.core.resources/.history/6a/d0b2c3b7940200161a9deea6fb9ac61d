package org.apache.cordova.media;

import android.content.ComponentName;
import android.content.Context;
import android.content.Intent;
import android.media.AudioManager;
import android.media.AudioManager.OnAudioFocusChangeListener;
import android.provider.MediaStore.Audio.AudioColumns;
import android.support.v4.media.MediaMetadataCompat;
import android.support.v4.media.session.MediaSessionCompat;
import android.support.v4.media.session.PlaybackStateCompat;
import android.util.Log;
import android.view.KeyEvent;

public class LockScreenMediaControl implements OnAudioFocusChangeListener{

	private AudioPlayer mAudioPlayer;
	private Context mcContext;
	private AudioManager mAudioManager;
	private MediaSessionCompat mMediaSessionCompat;
	
	/**
	 * Initializes the remote control client
	 */
	private void setupMediaSession(Context context) {
		/* Activate Audio Manager */
		mAudioManager = (AudioManager) context.getSystemService(Context.AUDIO_SERVICE);
		int focusGain = mAudioManager.requestAudioFocus(this,
				AudioManager.STREAM_MUSIC, AudioManager.AUDIOFOCUS_GAIN);

		if (focusGain != AudioManager.AUDIOFOCUS_GAIN) {
		    return; //Failed to gain audio focus
		}
		
		ComponentName mRemoteControlResponder = new ComponentName(
				context.getPackageName(), MediaButtonReceiver.class.getName());
		final Intent mediaButtonIntent = new Intent(Intent.ACTION_MEDIA_BUTTON);
		mediaButtonIntent.setComponent(mRemoteControlResponder);
		mMediaSessionCompat = new MediaSessionCompat(context,
				"JairSession", mRemoteControlResponder, null);
		mMediaSessionCompat
				.setFlags(MediaSessionCompat.FLAG_HANDLES_MEDIA_BUTTONS
						| MediaSessionCompat.FLAG_HANDLES_TRANSPORT_CONTROLS);
		PlaybackStateCompat playbackStateCompat = new PlaybackStateCompat.Builder()
				.setActions(
						PlaybackStateCompat.ACTION_SEEK_TO
								| PlaybackStateCompat.ACTION_SKIP_TO_PREVIOUS
								| PlaybackStateCompat.ACTION_SKIP_TO_NEXT
								| PlaybackStateCompat.ACTION_PLAY
								| PlaybackStateCompat.ACTION_PAUSE
								| PlaybackStateCompat.ACTION_STOP)
				.setState(
						isPlaying() ? PlaybackStateCompat.STATE_PLAYING
								: PlaybackStateCompat.STATE_PAUSED,
						getCurrentPosition(), 1.0f).build();
		mMediaSessionCompat.setPlaybackState(playbackStateCompat);
		mMediaSessionCompat.setCallback(mMediaSessionCallback);
		mMediaSessionCompat.setSessionActivity(retrievePlaybackActions(5));
		mMediaSessionCompat.setActive(true);
		updateMediaSessionMetaData();
		mTransportController = mMediaSessionCompat.getController()
				.getTransportControls();
	}

	/**
	 * Updates the lockscreen controls, if enabled.
	 */
	private void updateMediaSessionMetaData() {
		MediaMetadataCompat.Builder builder = new MediaMetadataCompat.Builder();
		builder.putString(MediaMetadataCompat.METADATA_KEY_ARTIST,
				getArtistName());
		builder.putString(MediaMetadataCompat.METADATA_KEY_ALBUM,
				getAlbumName());
		builder.putString(MediaMetadataCompat.METADATA_KEY_TITLE,
				getTrackName());
		builder.putLong(MediaMetadataCompat.METADATA_KEY_DURATION,
				getDuration());
		builder.putBitmap(MediaMetadataCompat.METADATA_KEY_ALBUM_ART,
				MusicUtils.getArtwork(this, getAlbumID(), true));
		mMediaSessionCompat.setMetadata(builder.build());
	}
	
	
	private final MediaSessionCompat.Callback mMediaSessionCallback = new MediaSessionCompat.Callback() {

	    @Override
	    public boolean onMediaButtonEvent(Intent mediaButtonEvent) {
	        final String intentAction = mediaButtonEvent.getAction();
	        if (AudioManager.ACTION_AUDIO_BECOMING_NOISY.equals(intentAction)) {
	            if (PrefUtils.isHeadsetPause(getBaseContext())) {
	                Log.d(LOG_TAG, "Headset disconnected");
	                pause();
	            }
	        } else if (Intent.ACTION_MEDIA_BUTTON.equals(intentAction)) {
	            final KeyEvent event = mediaButtonEvent.getParcelableExtra(Intent.EXTRA_KEY_EVENT);
	            if (event == null) return super.onMediaButtonEvent(mediaButtonEvent);
	            final int keycode = event.getKeyCode();
	            final int action = event.getAction();
	            final long eventTime = event.getEventTime();
	            if (event.getRepeatCount() == 0 && action == KeyEvent.ACTION_DOWN) {
	                switch (keycode) {
	                    case KeyEvent.KEYCODE_HEADSETHOOK:
	                        if (eventTime - mLastClickTime < DOUBLE_CLICK) {
	                            playNext(mSongNumber);
	                            mLastClickTime = 0;
	                        } else {
	                            if (isPlaying())
	                                pause();
	                            else resume();
	                            mLastClickTime = eventTime;
	                        }
	                        break;
	                    case KeyEvent.KEYCODE_MEDIA_STOP:
	                        mTransportController.stop();
	                        break;
	                    case KeyEvent.KEYCODE_MEDIA_PLAY_PAUSE:
	                        if (isMediaPlayerActive()) {
	                            if (isPlaying()) mTransportController.pause();
	                            else mTransportController.play();
	                        }
	                        break;
	                    case KeyEvent.KEYCODE_MEDIA_NEXT:
	                        mTransportController.skipToNext();
	                        break;
	                    case KeyEvent.KEYCODE_MEDIA_PREVIOUS:
	                        mTransportController.skipToPrevious();
	                        break;
	                    case KeyEvent.KEYCODE_MEDIA_PAUSE:
	                        mTransportController.pause();
	                        break;
	                    case KeyEvent.KEYCODE_MEDIA_PLAY:
	                        mTransportController.play();
	                        break;
	                }
	            }
	        }
	        return super.onMediaButtonEvent(mediaButtonEvent);
	    }

	    @Override
	    public void onPlay() {
	        super.onPlay();
	        resume();
	    }

	    @Override
	    public void onPause() {
	        super.onPause();
	        pause();
	    }

	    @Override
	    public void onSkipToNext() {
	        super.onSkipToNext();
	        playNext(mSongNumber);
	    }

	    @Override
	    public void onSkipToPrevious() {
	        super.onSkipToPrevious();
	        playPrevious(mSongNumber);
	    }

	    @Override
	    public void onSeekTo(long pos) {
	        super.onSeekTo(pos);
	        seekTo(pos);
	    }

	    @Override
	    public void onStop() {
	        super.onStop();
	        pause();
	        commitMusicData();
	        updatePlayingUI(STOP_ACTION);
	        stopSelf();
	    }
	};

	@Override
	public void onAudioFocusChange(int arg0) {
		// TODO Auto-generated method stub
		
	}

}
